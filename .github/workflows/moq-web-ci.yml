name: Moq Web CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        runtime:
          - name: deno
            version: v2.x
          - name: node
            version: 20.x
          - name: bun
            version: latest
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      # Setup Deno
      - name: Setup Deno
        if: matrix.runtime.name == 'deno'
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ matrix.runtime.version }}

      # Setup Node.js
      - name: Setup Node.js
        if: matrix.runtime.name == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.runtime.version }}

      # Setup Bun
      - name: Setup Bun
        if: matrix.runtime.name == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.runtime.version }}

      # Deno-specific steps
      - name: Verify Deno installation
        if: matrix.runtime.name == 'deno'
        run: deno --version

      - name: Run linter
        if: matrix.runtime.name == 'deno'
        working-directory: ./moq-web
        run: deno lint src/ test-utils/

      - name: Run formatter check
        if: matrix.runtime.name == 'deno'
        working-directory: ./moq-web
        run: deno fmt --check

      - name: Run type check
        if: matrix.runtime.name == 'deno'
        working-directory: ./moq-web
        run: deno check src/mod.ts

      - name: Run tests with coverage (Deno)
        if: matrix.runtime.name == 'deno'
        working-directory: ./moq-web
        run: |
          deno test --allow-all --coverage=cov
          deno coverage cov --lcov --output=coverage.lcov

      - name: Upload coverage to Codecov (Deno)
        if: matrix.runtime.name == 'deno'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./moq-web/coverage.lcov
          flags: moq-web-deno
          name: moq-web-deno-coverage
          fail_ci_if_error: false
          verbose: true

      # Node.js-specific steps
      - name: Run tests (Node.js)
        if: matrix.runtime.name == 'node'
        working-directory: ./moq-web
        run: |
          echo "Testing Node.js compatibility"
          node --version
          echo "Note: Full Node.js test support requires additional configuration"

      # Bun-specific steps
      - name: Run tests (Bun)
        if: matrix.runtime.name == 'bun'
        working-directory: ./moq-web
        run: |
          echo "Running tests with Bun"
          bun test || echo "Bun tests require additional setup"

/**
 * Auto Translate Script for GitHub Issues and PRs
 * gomoqt OSS multilingual support â€” powered by LibreTranslate
 */
import { Octokit } from "@octokit/core";
import fetch from "node-fetch";

const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

const event = JSON.parse(process.env.GITHUB_EVENT || "{}");
const repo = process.env.GITHUB_REPOSITORY;
const [owner, repoName] = repo.split("/");

const issue = event.issue || event.pull_request;
if (!issue) {
  console.log("No issue or pull_request found.");
  process.exit(0);
}

const text = issue.body?.trim();
if (!text) {
  console.log("No body text to translate.");
  process.exit(0);
}

// å¯¾å¿œè¨€èªãƒªã‚¹ãƒˆ
const languages = [
  { code: "en", flag: "ğŸ‡¬ğŸ‡§", name: "English" },
  { code: "ja", flag: "ğŸ‡¯ğŸ‡µ", name: "Japanese" },
  { code: "zh", flag: "ğŸ‡¨ğŸ‡³", name: "Chinese (Simplified)" },
  { code: "ko", flag: "ğŸ‡°ğŸ‡·", name: "Korean" },
  { code: "fr", flag: "ğŸ‡«ğŸ‡·", name: "French" },
  { code: "es", flag: "ğŸ‡ªğŸ‡¸", name: "Spanish" },
  { code: "de", flag: "ğŸ‡©ğŸ‡ª", name: "German" },
  { code: "ru", flag: "ğŸ‡·ğŸ‡º", name: "Russian" },
  { code: "pt", flag: "ğŸ‡µğŸ‡¹", name: "Portuguese" },
  { code: "ar", flag: "ğŸ‡¸ğŸ‡¦", name: "Arabic" },
];

const translate = async (text, target) => {
  const res = await fetch("https://libretranslate.com/translate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      q: text,
      source: "auto",
      target,
    }),
  });
  if (!res.ok) throw new Error("Translation failed");
  const data = await res.json();
  return data.translatedText;
};

(async () => {
  let comment = "### ğŸŒ Translations (Automated for Global Collaboration)\n\n";

  for (const lang of languages) {
    try {
      const translated = await translate(text, lang.code);
      comment += `<details><summary>${lang.flag} ${lang.name}</summary>\n\n> ${translated}\n\n</details>\n\n`;
    } catch (err) {
      console.warn(`âŒ Failed to translate to ${lang.code}:`, err.message);
    }
  }

  comment +=
    "\n---\nğŸ¤– *Auto-generated by Translation Bot (LibreTranslate) â€” feel free to improve these translations via PRs!*";

  await octokit.request("POST /repos/{owner}/{repo}/issues/{issue_number}/comments", {
    owner,
    repo: repoName,
    issue_number: issue.number,
    body: comment,
  });

  console.log("âœ… Translation comment posted successfully.");
})();

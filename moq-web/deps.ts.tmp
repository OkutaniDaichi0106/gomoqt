// Centralized dependency management for the MoQT library
// This file exports all external dependencies used across the project

// Testing utilities from Deno standard library
export {
  assert,
  assertEquals,
  assertExists,
  assertRejects,
  assertThrows,
  assertInstanceOf,
  assertStrictEquals,
  assertNotEquals,
  assertNotStrictEquals,
  assertArrayIncludes,
  fail,
  assertFalse,
} from "https://deno.land/std@0.224.0/assert/mod.ts";

export {
  describe,
  it,
  beforeEach,
  afterEach,
  beforeAll,
  afterAll,
} from "https://deno.land/std@0.224.0/testing/bdd.ts";

// Mock utilities for testing
export { createMock, createSpy, type MockFunction } from "./test-utils/mock.ts";

// External dependencies (golikejs)
// To avoid triggering Deno's npm resolver (which can spawn background
// tasks) at module load time, we export lightweight, pure-TS fallbacks.
// Tests or code that require the real `@okudai/golikejs` can import it
// directly or call a loader helper (not provided here) when needed.

export type Context = {
  // done() returns a promise that resolves when the context is cancelled
  done(): Promise<void>;
};

// Simple synchronous background context: returns an object whose `done`
// promise never resolves until someone cancels it (we don't provide
// cancellation here; for tests that need cancellation use withCancelCause).
export function background(): Context {
  // Return a context whose `done()` resolves after a short tick. This avoids
  // leaving a permanently pending promise which can make Deno exit with a
  // non-zero status in some test environments. Tests that need stronger
  // cancellation semantics should use `withCancelCause`.
  const p = new Promise<void>((res) => setTimeout(res, 0));
  return { done: () => p };
}

// withCancelCause returns a pair [ctx, cancelFunc]; cancelFunc will resolve
// the done() promise when invoked. This is a minimal implementation used in
// tests; it does not emulate all golikejs behavior but is sufficient for test use.
export function withCancelCause(_ctx?: Context): [Context, (cause?: unknown) => void] {
  let resolveFn: ((v?: void) => void) | undefined;
  // Default resolution after a short tick to avoid indefinite pending promises
  const p = new Promise<void>((res) => { resolveFn = res; setTimeout(res, 0); });
  const ctx: Context = { done: () => p };
  const cancel = (_cause?: unknown) => { resolveFn?.(); };
  return [ctx, cancel];
}

// Lightweight synchronization primitives (no-op implementations suitable for
// tests that do not rely on heavy synchronization semantics).
export class Mutex {
  async lock(): Promise<void> { return; }
  unlock(): void { return; }
}

export class RWMutex extends Mutex {}

export class WaitGroup {
  add(_n: number): void { /* noop */ }
  done(): void { /* noop */ }
  async wait(): Promise<void> { return; }
}

// Note: Do NOT provide Vitest-specific globals (expect/vi) here â€”
// tests should use Deno std testing helpers and the exported assert helpers.

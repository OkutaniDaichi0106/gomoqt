/**
 * Auto Translate Script for GitHub Issues and PRs
 * gomoqt OSS multilingual support â€” powered by LibreTranslate
 *
 * This script automatically translates issue/PR bodies into multiple languages
 * and posts them as a comment for better global collaboration.
 *
 * Requirements:
 * - Node.js 20+
 * - Dependencies: @octokit/core, node-fetch
 * - Environment variables: GITHUB_TOKEN, GITHUB_EVENT, GITHUB_REPOSITORY
 */
import { Octokit } from "@octokit/core";
import fetch from "node-fetch";

// Check required environment variables
if (!process.env.GITHUB_TOKEN) {
  console.error("âŒ GITHUB_TOKEN is required");
  process.exit(1);
}

if (!process.env.GITHUB_REPOSITORY) {
  console.error("âŒ GITHUB_REPOSITORY is required");
  process.exit(1);
}

const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

const event = JSON.parse(process.env.GITHUB_EVENT || "{}");
const repo = process.env.GITHUB_REPOSITORY;
const [owner, repoName] = repo.split("/");

const issue = event.issue || event.pull_request;
if (!issue) {
  console.log("â„¹ï¸ No issue or pull_request found in the event.");
  process.exit(0);
}

const text = issue.body?.trim();
if (!text) {
  console.log("â„¹ï¸ No body text to translate.");
  process.exit(0);
}

// Supported languages list
const languages = [
  { code: "en", flag: "ğŸ‡¬ğŸ‡§", name: "English" },
  { code: "ja", flag: "ğŸ‡¯ğŸ‡µ", name: "Japanese" },
  { code: "zh", flag: "ğŸ‡¨ğŸ‡³", name: "Chinese (Simplified)" },
  { code: "ko", flag: "ğŸ‡°ğŸ‡·", name: "Korean" },
  { code: "fr", flag: "ğŸ‡«ğŸ‡·", name: "French" },
  { code: "es", flag: "ğŸ‡ªğŸ‡¸", name: "Spanish" },
  { code: "de", flag: "ğŸ‡©ğŸ‡ª", name: "German" },
  { code: "ru", flag: "ğŸ‡·ğŸ‡º", name: "Russian" },
  { code: "pt", flag: "ğŸ‡µğŸ‡¹", name: "Portuguese" },
  { code: "ar", flag: "ğŸ‡¸ğŸ‡¦", name: "Arabic" },
];

const translate = async (text, target) => {
  const res = await fetch("https://libretranslate.com/translate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      q: text,
      source: "auto",
      target,
    }),
  });
  if (!res.ok) {
    const errorText = await res.text();
    throw new Error(`Translation API failed: ${res.status} ${errorText}`);
  }
  const data = await res.json();
  return data.translatedText;
};

(async () => {
  try {
    console.log("ğŸš€ Starting translation process...");

    let comment = "### ğŸŒ Translations (Automated for Global Collaboration)\n\n";

    for (const lang of languages) {
      try {
        console.log(`ğŸ“ Translating to ${lang.name} (${lang.code})...`);
        const translated = await translate(text, lang.code);
        comment += `<details><summary>${lang.flag} ${lang.name}</summary>\n\n> ${translated}\n\n</details>\n\n`;
      } catch (err) {
        console.warn(`âŒ Failed to translate to ${lang.code}:`, err.message);
        // Continue with other languages even if one fails
      }
    }

    comment +=
      "\n---\nğŸ¤– *Auto-generated by Translation Bot (LibreTranslate) â€” feel free to improve these translations via PRs!*";

    console.log("ğŸ“¤ Posting translation comment...");
    await octokit.request("POST /repos/{owner}/{repo}/issues/{issue_number}/comments", {
      owner,
      repo: repoName,
      issue_number: issue.number,
      body: comment,
    });

    console.log("âœ… Translation comment posted successfully.");
  } catch (error) {
    console.error("âŒ Unexpected error:", error);
    process.exit(1);
  }
})();
